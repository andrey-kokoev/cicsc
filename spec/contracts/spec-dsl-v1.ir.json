{
  "version": 0,
  "types": {
    "Ticket": {
      "id_type": "string",
      "states": [
        "new",
        "triage",
        "done"
      ],
      "initial_state": "new",
      "attrs": {
        "title": {
          "type": "string"
        },
        "lane": {
          "type": "string",
          "default": "todo"
        }
      },
      "shadows": {},
      "commands": {
        "open": {
          "input": {},
          "guard": {
            "expr": {
              "and": [
                {
                  "and": [
                    {
                      "call": {
                        "fn": "has_role",
                        "args": [
                          {
                            "var": {
                              "actor": true
                            }
                          },
                          {
                            "lit": {
                              "string": "agent"
                            }
                          }
                        ]
                      }
                    }
                  ]
                },
                {
                  "call": {
                    "fn": "auth_ok",
                    "args": [
                      {
                        "var": {
                          "actor": true
                        }
                      },
                      {
                        "lit": {
                          "string": "can_open"
                        }
                      }
                    ]
                  }
                }
              ]
            }
          },
          "emits": [
            {
              "event_type": "ticket_opened",
              "payload": {
                "title": {
                  "var": {
                    "input": {
                      "field": "title"
                    }
                  }
                }
              }
            }
          ]
        }
      },
      "reducer": {
        "ticket_opened": [
          {
            "set_state": {
              "expr": {
                "lit": {
                  "string": "triage"
                }
              }
            }
          },
          {
            "set_attr": {
              "name": "title",
              "expr": {
                "var": {
                  "e_payload": {
                    "path": "title"
                  }
                }
              }
            }
          }
        ]
      }
    }
  },
  "policies": {
    "can_open": {
      "params": [],
      "expr": {
        "call": {
          "fn": "has_role",
          "args": [
            {
              "lit": {
                "string": "agent"
              }
            }
          ]
        }
      }
    }
  },
  "views": {
    "tickets_by_lane": {
      "kind": "lanes",
      "on_type": "Ticket",
      "query": {
        "source": {
          "snap": {
            "type": "Ticket"
          }
        },
        "pipeline": []
      }
    }
  },
  "migrations": {
    "v0_to_v1": {
      "from_version": 0,
      "to_version": 1,
      "on_type": "Ticket",
      "event_transforms": {
        "ticket_opened": {
          "emit_as": "ticket_created",
          "drop": false
        }
      },
      "state_map": {
        "new": "new",
        "triage": "new",
        "done": "done"
      }
    }
  }
}