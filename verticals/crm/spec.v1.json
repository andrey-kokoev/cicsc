{
  "version": 0,
  "policies": {
    "can_progress_lead": {
      "params": ["actor"],
      "allow": { "role_is": "sales_rep" }
    }
  },
  "entities": {
    "Lead": {
      "id": "string",
      "states": ["new", "qualified", "proposal", "won", "lost"],
      "initial": "new",
      "attributes": {
        "name": { "type": "string" },
        "owner_id": { "type": "string" },
        "stage": { "type": "enum", "values": ["new", "qualified", "proposal", "won", "lost"] }
      },
      "shadows": {
        "score_i": { "type": "int" },
        "conversion_i": { "type": "int" }
      },
      "commands": {
        "create": {
          "inputs": {
            "name": { "type": "string" },
            "owner_id": { "type": "string" }
          },
          "emit": [{ "type": "lead_created", "payload": { "name": { "var": { "input": { "field": "name" } } }, "owner_id": { "var": { "input": { "field": "owner_id" } } } } }]
        },
        "qualify": {
          "when": { "state_is": "new" },
          "auth": { "policy": "can_progress_lead" },
          "emit": [{ "type": "lead_qualified", "payload": {} }]
        },
        "propose": {
          "when": { "state_is": "qualified" },
          "auth": { "policy": "can_progress_lead" },
          "emit": [{ "type": "proposal_sent", "payload": {} }]
        },
        "win": {
          "when": { "state_is": "proposal" },
          "auth": { "policy": "can_progress_lead" },
          "emit": [{ "type": "lead_won", "payload": {} }]
        },
        "lose": {
          "when": { "state_is": "proposal" },
          "auth": { "policy": "can_progress_lead" },
          "emit": [{ "type": "lead_lost", "payload": {} }]
        }
      },
      "reducers": {
        "lead_created": [
          { "set_attr": { "field": "name", "value": { "var": { "e_payload": { "path": "name" } } } } },
          { "set_attr": { "field": "owner_id", "value": { "var": { "e_payload": { "path": "owner_id" } } } } },
          { "set_attr": { "field": "stage", "value": "new" } },
          { "set_shadow": { "field": "score_i", "value": 10 } },
          { "set_shadow": { "field": "conversion_i", "value": 0 } }
        ],
        "lead_qualified": [
          { "set_state": "qualified" },
          { "set_attr": { "field": "stage", "value": "qualified" } },
          { "set_shadow": { "field": "score_i", "value": 40 } }
        ],
        "proposal_sent": [
          { "set_state": "proposal" },
          { "set_attr": { "field": "stage", "value": "proposal" } },
          { "set_shadow": { "field": "score_i", "value": 60 } }
        ],
        "lead_won": [
          { "set_state": "won" },
          { "set_attr": { "field": "stage", "value": "won" } },
          { "set_shadow": { "field": "score_i", "value": 100 } },
          { "set_shadow": { "field": "conversion_i", "value": 1 } }
        ],
        "lead_lost": [
          { "set_state": "lost" },
          { "set_attr": { "field": "stage", "value": "lost" } },
          { "set_shadow": { "field": "score_i", "value": 0 } },
          { "set_shadow": { "field": "conversion_i", "value": 0 } }
        ]
      }
    }
  },
  "views": {
    "pipeline": {
      "kind": "lanes",
      "on": "Lead",
      "lanes": {
        "states": ["new", "qualified", "proposal", "won", "lost"],
        "order_by": { "field": "updated_ts", "dir": "desc" },
        "limit": 500
      }
    },
    "owner_pipeline": {
      "kind": "metric",
      "on": "Lead",
      "query": {
        "source": { "snap": { "type": "Lead" } },
        "pipeline": [
          {
            "group_by": {
              "keys": [{ "name": "owner_id", "expr": { "get": { "expr": { "var": { "row": { "field": "attrs_json" } } }, "path": "owner_id" } } }],
              "aggs": {
                "rows_count": { "count": {} },
                "conversions": { "sum": { "expr": { "var": { "row": { "field": "conversion_i" } } } } }
              }
            }
          }
        ]
      }
    }
  }
}
